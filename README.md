# Rails and Heroku Boilerplate mini-guide

## Preparation

1. Create a `.env` for sensitive settings (`touch .env`).
1. Generate new `development` and `test` secrets (`bundle exec rails secret`).
1. Store them in `.env` with keys `SECRET_KEY_BASE_<DEVELOPMENT|TEST>`
   respectively.
1. Setup your database with `bin/rails [db:drop] db:create db:migrate db:seed`.
1. Run the API server with `bin/rails server`.

## .env file

```
SECRET_KEY_BASE_DEVELOPMENT={ENTER YOUR KEY HERE}
SECRET_KEY_BASE_TEST={ENTER YOUR OTHER KEY HERE}
```

## Commands

Developers should run these often!

- `bin/rails routes` lists the endpoints available in your API.
- `bin/rails test` runs automated tests.
- `bin/rails console` opens a REPL that pre-loads the API.
- `bin/rails db` opens your database client and loads the correct database.
- `bin/rails server` starts the API.
- `scripts/*.sh` run various `curl` commands to test the API. See below.

##### View Database information in pSQL

```
bin/rails db
SELECT * from {table};
```

### OpenReadController vs ProtectedController

- OpenReadController does not require authentication for GET actions
- ProtectedController requires authentication for ALL actions
- OpenReadController SHOW action looks for current user by default

### Rails Commands

```
// generates scaffold
bin/rails g scaffold {my_resource} field0:string field1:string field2:integer
// adds relationship between tables
bin/rails g migration AddUserToResources user:references
```

### Debugging Rails

- Do the action
- Check terminal that has Rails server running

### Create a New Heroku App

Go to the root of your repo and run `heroku create {APP_NAME}`. This will create an
_autogenerated_ name for your app, and add a new remote repository to your repo
 called _heroku_. View your remotes by typing `git remote -v`. You should see
something like:

```
heroku create my-app
```

```sh
    heroku  git@heroku.com:agile-badlands-7658.git (fetch)
    heroku  git@heroku.com:agile-badlands-7658.git (push)
    origin  git@github.com:tdyer/wdi_4_rails_hw_tdd_hacker_news.git (fetch)
    origin  git@github.com:tdyer/wdi_4_rails_hw_tdd_hacker_news.git (push)
```

---

### Push `master` to Heroku

Only keep clean, working code on `master`. After you complete a feature, merge
it onto `master`. Push your updated `master` to GitHub, then to Heroku.

```sh
git checkout master
git merge my-feature # merge your working code
git push origin master # update GitHub
git push heroku master # update Heroku
```

---

### Update Heroku's Database

Once you've deployed your code, you can safely run new migrations. You'll need
to do this step every time you have new migrations.

```sh
heroku run rails db:migrate
```

If you have seeds or examples, or if you've updated seeds or examples, you
should also run them on Heroku.

```sh
heroku run rails db:seed
heroku run rails db:examples
```

---

### Nuke Heroku Database

```
heroku pg:reset
heroku run rails db:reset
```

### Set Your Secrets


Set your environmental variables in your Heroku app.

```
bundle exec rails secret
```

```sh
heroku config:set SECRET_KEY_BASE=$(rails secret)
```

```sh
heroku config:set SECRET_TOKEN=$(rails secret)
```

```sh
heroku config:set CLIENT_ORIGIN=https://yourgithubname.github.io
```

_**IMPORTANT NOTE:** The URL in the above command must NOT have a trailing slash
on the end. If you're experiencing CORS issues, ensure that your `CLIENT_ORIGIN`
variable has no slash on the end._

---

### Check Your Work

Restart your application and check it out in the browser.

```sh
heroku restart
heroku open
```

You'll probably see something like this:

![](https://cloud.githubusercontent.com/assets/388761/13259005/93c9fdf6-da23-11e5-9c90-19c59580944a.png)

That's normal, **unless** you have defined a root route.

---

### Change Your App's Name (optional)

If you wish you can rename your app at any time. It must be unique across all
apps deployed to Heroku.

```sh
heroku apps:rename newname
```

Your app will become immediately available at it's new subdomain,
`newname.herokuapp.com`.

---

## WARNING: Ephemeral Filesystem

One serious limitation of Heroku is that it provides an "ephemeral filesystem";
in other words, if you try to save a new file inside the repo (e.g. an uploaded
image file), it will disappear when your app is restarted or redeployed.

As an example, try running the following commands:

```sh
heroku run bash
touch happy.txt; echo 'is happy' > happy.txt
cat happy.txt
```

Then, hit Ctrl-D to get out of Heroku bash shell. If you re-open the shell and
run `ls -l`, `happy.txt` will be missing!

The typical workaround is to save files in cloud storage such as [Amazon
S3](https://aws.amazon.com/s3/); more on this in the near future.

![](https://www.thehinzadventures.com/wp-content/uploads/2015/03/54843046.jpg)

## Troubleshooting

These are the commands required for deploying to Heroku with rails. If your
Heroku deployment isn't working as expected, review these steps carefully.

- `heroku create`
- `git push heroku master`
- `heroku run rails db:migrate`
- `heroku run rails db:seed`
- `heroku config:set SECRET_KEY_BASE=$(rails secret)`
- `heroku config:set SECRET_TOKEN=$(rails secret)`
- `heroku config:set CLIENT_ORIGIN=https://yourgithubname.github.io`
- `heroku apps:rename newname` (optional)
- `heroku restart`
- `heroku open`

If you have successfully deployed your Rails API but are experiencing problems
with the production database (note that the production database is _entirely_
separate from your development database), you may find it useful to use the
command `heroku pg:psql` to connect to the production database with the PSQL
client. Be cautious though, it's possible to accidentally destroy production
data from the CLI.

## Additional Resources

- [Heroku Command Line](https://devcenter.heroku.com/categories/command-line)
- [Heroku Rails Deployment](https://devcenter.heroku.com/articles/getting-started-with-rails5)
